<JobCardScreen>:
    name: "job_card"
    BoxLayout:
        orientation: 'vertical'
        padding: 24
        spacing: 16
        ScrollView:
            do_scroll_x: False
            BoxLayout:
                orientation: 'vertical'
                size_hint_y: None
                height: self.minimum_height
                spacing: 12
                Label:
                    text: "New Job Card"
                    font_size: '32sp'
                    bold: True
                    size_hint_y: None
                    height: '40dp'
                Label:
                    text: "Name"
                    font_size: '16sp'
                    size_hint_y: None
                    height: '28dp'
                TextInput:
                    id: name
                    hint_text: "Name"
                    multiline: False
                    size_hint_y: None
                    height: '40dp'
                Label:
                    text: "Phone"
                    font_size: '16sp'
                    size_hint_y: None
                    height: '28dp'
                TextInput:
                    id: phone
                    hint_text: "Phone"
                    multiline: False
                    size_hint_y: None
                    height: '40dp'
                Label:
                    text: "Place"
                    font_size: '16sp'
                    size_hint_y: None
                    height: '28dp'
                TextInput:
                    id: place
                    hint_text: "Place"
                    multiline: False
                    size_hint_y: None
                    height: '40dp'
                Label:
                    text: "Bike No."
                    font_size: '16sp'
                    size_hint_y: None
                    height: '28dp'
                TextInput:
                    id: bike_no
                    hint_text: "Bike No."
                    multiline: False
                    size_hint_y: None
                    height: '40dp'
                Label:
                    text: "Model"
                    font_size: '16sp'
                    size_hint_y: None
                    height: '28dp'
                TextInput:
                    id: model
                    hint_text: "Model"
                    multiline: False
                    size_hint_y: None
                    height: '40dp'
                Label:
                    text: "Year"
                    font_size: '16sp'
                    size_hint_y: None
                    height: '28dp'
                TextInput:
                    id: year
                    hint_text: "Year"
                    multiline: False
                    size_hint_y: None
                    height: '40dp'
                Label:
                    text: "Engine Number"
                    font_size: '16sp'
                    size_hint_y: None
                    height: '28dp'
                TextInput:
                    id: engine_no
                    hint_text: "Engine Number"
                    multiline: False
                    size_hint_y: None
                    height: '40dp'
                Label:
                    text: "Chassis Number"
                    font_size: '16sp'
                    size_hint_y: None
                    height: '28dp'
                TextInput:
                    id: chassis_no
                    hint_text: "Chassis Number"
                    multiline: False
                    size_hint_y: None
                    height: '40dp'
                Label:
                    text: "Approx. Amount"
                    font_size: '16sp'
                    size_hint_y: None
                    height: '28dp'
                TextInput:
                    id: approx_amount
                    hint_text: "Approx. Amount"
                    multiline: False
                    size_hint_y: None
                    height: '40dp'
                Label:
                    text: "Customer Demand"
                    font_size: '16sp'
                    size_hint_y: None
                    height: '28dp'
                TextInput:
                    id: customer_demand
                    hint_text: "Customer Demand"
                    multiline: True
                    size_hint_y: None
                    height: '80dp'
                Label:
                    text: "Mechanic Demand"
                    font_size: '16sp'
                    size_hint_y: None
                    height: '28dp'
                TextInput:
                    id: mech_demand
                    hint_text: "Mechanic Demand"
                    multiline: True
                    size_hint_y: None
                    height: '80dp'
                BoxLayout:
                    orientation: 'horizontal'
                    size_hint_y: None
                    height: '40dp'
                    Label:
                        text: "In Time"
                        size_hint_x: 0.4
                        font_size: '15sp'
                    TextInput:
                        id: in_time
                        text: app.get_current_time()
                        readonly: True
                        size_hint_x: 0.6
                BoxLayout:
                    orientation: 'horizontal'
                    size_hint_y: None
                    height: '40dp'
                    Label:
                        text: "Est Time"
                        size_hint_x: 0.4
                        font_size: '15sp'
                    TextInput:
                        id: est_time
                        hint_text: "Select Est. Date & Time"
                        multiline: False
                        size_hint_x: 0.6
                        on_focus: app.open_datetime_picker(self) if self.focus else None
                BoxLayout:
                    orientation: 'horizontal'
                    size_hint_y: None
                    height: '48dp'
                    spacing: 10
                    Button:
                        text: "Cancel"
                        on_release: app.root.current = "dashboard"
                    Button:
                        text: "Generate PDF"
                        on_release: app.root.get_screen('job_card').generate_job_card_pdf(name.text, phone.text, place.text, bike_no.text, model.text, year.text, engine_no.text, chassis_no.text, approx_amount.text, customer_demand.text, mech_demand.text, in_time.text, est_time.text)
# --- BILLING SCREEN ---
<BillingScreen>:
    name: "billing"
#:kivy 2.1.0
#:import Factory kivy.factory.Factory

# --- GLOBAL STYLES ---

<ModernButton@Button>:
    background_normal: ''
    background_color: (1, 1, 1, 1)
    color: (0.2, 0.2, 0.2, 1)
    font_size: '18sp'
    font_name: 'Roboto'
    bold: False
    canvas.before:
        Color:
            rgba: (0.95, 0.95, 0.95, 1) if self.state == 'normal' else (0.9, 0.9, 0.9, 1)
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [12]
        Color:
            rgba: (0.85, 0.85, 0.85, 0.3)
        Line:
            rounded_rectangle: (self.x, self.y, self.width, self.height, 12)
            width: 1

<DashboardButton@ModernButton>:
    font_size: '20sp'
    color: (0.3, 0.3, 0.3, 1)
    canvas.before:
        Color:
            rgba: (1, 1, 1, 1) if self.state == 'normal' else (0.98, 0.98, 0.98, 1)
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [16]
        # Shadow effect
        Color:
            rgba: (0, 0, 0, 0.1)
        RoundedRectangle:
            pos: (self.x + 2, self.y - 2)
            size: self.size
            radius: [16]
        Color:
            rgba: (0.9, 0.9, 0.9, 0.4)
        Line:
            rounded_rectangle: (self.x, self.y, self.width, self.height, 16)
            width: 0.5

<PopupButton@Button>:
    background_normal: ''
    background_color: (0.2, 0.6, 1, 1)
    color: (1, 1, 1, 1)
    font_size: '16sp'
    font_name: 'Roboto'
    size_hint_y: None
    height: '48dp'
    canvas.before:
        Color:
            rgba: (0.2, 0.6, 1, 1) if self.state == 'normal' else (0.1, 0.5, 0.9, 1)
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [8]

# --- POPUPS ---

<ServicePopup@Popup>:
    title: "Service Options"
    title_color: (0.2, 0.2, 0.2, 1)
    title_size: '20sp'
    size_hint: 0.85, 0.5
    background: ''
    background_color: (1, 1, 1, 1)
    separator_color: (0.9, 0.9, 0.9, 1)
    separator_height: 1
    canvas.before:
        Color:
            rgba: (1, 1, 1, 1)
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [20]
        Color:
            rgba: (0, 0, 0, 0.1)
        Line:
            rounded_rectangle: (self.x, self.y, self.width, self.height, 20)
            width: 1
    BoxLayout:
        orientation: 'vertical'
        padding: 20
        spacing: 15
        PopupButton:
            text: "New Job Card"
            on_release: 
                root.dismiss()
                app.root.current = "job_card"
        PopupButton:
            text: "Additional Approval"
            on_release: root.dismiss()
        PopupButton:
            text: "View Job Card"
            on_release: root.dismiss()

<BillingPopup@Popup>:
    title: "Billing Options"
    title_color: (0.2, 0.2, 0.2, 1)
    title_size: '20sp'
    size_hint: 0.85, 0.4
    background: ''
    background_color: (1, 1, 1, 1)
    separator_color: (0.9, 0.9, 0.9, 1)
    separator_height: 1
    canvas.before:
        Color:
            rgba: (1, 1, 1, 1)
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [20]
        Color:
            rgba: (0, 0, 0, 0.1)
        Line:
            rounded_rectangle: (self.x, self.y, self.width, self.height, 20)
            width: 1
    BoxLayout:
        orientation: 'vertical'
        padding: 20
        spacing: 15

        PopupButton:
            text: "Generate Invoice"
            on_release:
                root.dismiss()
                Factory.GenerateInvoicePopup().open()


# --- GENERATE INVOICE POPUP ---
<GenerateInvoicePopup>:
    title: "Generate Invoice"
    size_hint: 0.9, 0.7
    auto_dismiss: False
    BoxLayout:
        orientation: 'vertical'
        padding: 20
        spacing: 15
        Label:
            text: "Enter Customer Details"
            font_size: '18sp'
            size_hint_y: None
            height: '30dp'
        TextInput:
            id: customer_name
            hint_text: "Name"
            multiline: False
            size_hint_y: None
            height: '40dp'
        TextInput:
            id: customer_phone
            hint_text: "Phone Number"
            multiline: False
            size_hint_y: None
            height: '40dp'
        TextInput:
            id: bike_number
            hint_text: "Bike Number"
            multiline: False
            size_hint_y: None
            height: '40dp'
        Label:
            text: "Select Services"
            font_size: '16sp'
            size_hint_y: None
            height: '28dp'
        GridLayout:
            cols: 1
            size_hint_y: None
            height: self.minimum_height
            BoxLayout:
                size_hint_y: None
                height: '32dp'
                CheckBox:
                    id: bike_wash
                    active: False
                    size_hint_x: None
                    width: '32dp'
                Label:
                    text: "Bike wash - ₹100"
                    font_size: '15sp'
                    color: (0.2, 0.2, 0.2, 1)
                    halign: 'left'
                    valign: 'middle'
                    text_size: self.size
            BoxLayout:
                size_hint_y: None
                height: '32dp'
                CheckBox:
                    id: car_wash
                    active: False
                    size_hint_x: None
                    width: '32dp'
                Label:
                    text: "Car wash - ₹300"
                    font_size: '15sp'
                    color: (0.2, 0.2, 0.2, 1)
                    halign: 'left'
                    valign: 'middle'
                    text_size: self.size
            BoxLayout:
                size_hint_y: None
                height: '32dp'
                CheckBox:
                    id: bike_repairs
                    active: False
                    size_hint_x: None
                    width: '32dp'
                Label:
                    text: "Bike repairs - ₹200"
                    font_size: '15sp'
                    color: (0.2, 0.2, 0.2, 1)
                    halign: 'left'
                    valign: 'middle'
                    text_size: self.size
            BoxLayout:
                size_hint_y: None
                height: '32dp'
                CheckBox:
                    id: car_repairs
                    active: False
                    size_hint_x: None
                    width: '32dp'
                Label:
                    text: "Car repair - ₹2000"
                    font_size: '15sp'
                    color: (0.2, 0.2, 0.2, 1)
                    halign: 'left'
                    valign: 'middle'
                    text_size: self.size
        BoxLayout:
            size_hint_y: None
            height: '48dp'
            spacing: 10
            Button:
                text: "Cancel"
                on_release: root.dismiss()
            Button:
                text: "Generate"
                on_release: app.root.get_screen('billing').generate_invoice(customer_name.text, customer_phone.text, bike_number.text, bike_wash.active, car_wash.active, bike_repairs.active, car_repairs.active); root.dismiss()

# --- SCREEN MANAGER ---

<WorkshopWindowManager>:
    DashboardScreen:
    StockListScreen:
    JobCardScreen:
    BillingScreen:
    AnalyticsScreen:

# --- MODERN DASHBOARD LAYOUT ---

<DashboardScreen>:
    name: "dashboard"
    canvas.before:
        Color:
            rgba: (0.98, 0.98, 0.98, 1)  # Light gray background
        Rectangle:
            pos: self.pos
            size: self.size

    BoxLayout:
        orientation: "vertical"
        padding: 16
        spacing: 16

        # --- HEADER SECTION WITH IMAGES ---
        BoxLayout:
            size_hint_y: 0.3
            spacing: dp(10)
            padding: dp(10)

            # Rectangle Image on the Left
            Image:
                source: "assets/images/rectangle_image.png"
                allow_stretch: True
                keep_ratio: True
                size_hint: None, None
                width: dp(800)
                height: dp(200)

            # Square Image on the Right
            Image:
                source: "assets/images/square_image.png"
                allow_stretch: True 
                keep_ratio: True
                size_hint: None, None
                width: dp(200)
                height: dp(200)

        # --- MIDDLE SECTION: DATE AND TIME ---
        BoxLayout:
            orientation: "horizontal"
            size_hint_y: 0.1
            spacing: dp(10)
            padding: dp(10)

            Label:
                text: "Date: " + app.get_current_time().split(" ")[0]
                font_size: dp(16)
                halign: 'left'
                color: (0.5, 0.5, 0.5, 1)

            Label:
                text: "Time: " + app.get_current_time().split(" ")[1] + " " + app.get_current_time().split(" ")[2]
                font_size: dp(16)
                halign: 'right'
                color: (0.5, 0.5, 0.5, 1)

        # --- MAIN NAVIGATION GRID ---
        GridLayout:
            cols: 2
            padding: 8
            spacing: 16
            size_hint_y: 0.65

            DashboardButton:
                text: "SERVICE"
                on_release: root.open_service_popup()

            DashboardButton:
                text: "SPARE PARTS"
                on_release: app.root.current = "stock_list"

            DashboardButton:
                text: "BILLING"
                on_release: root.open_billing_popup()

            DashboardButton:
                text: "HISTORY"
                on_release: app.root.current = "analytics"